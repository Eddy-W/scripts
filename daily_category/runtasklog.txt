hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0112_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-01-12'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0112_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0112_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0112_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0112_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-01-12'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-01-12'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-01-12'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0112_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0112_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0112_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-01-12'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0112_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0112_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-01-12' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0112_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0112_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0112_req;
drop table user_wangwentao_adx_analysis_0112_req_trans;
drop table user_wangwentao_adx_analysis_0112_bid;
drop table user_wangwentao_adx_analysis_0112_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0113_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-01-13'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0113_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0113_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0113_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0113_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-01-13'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-01-13'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-01-13'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0113_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0113_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0113_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-01-13'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0113_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0113_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-01-13' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0113_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0113_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0113_req;
drop table user_wangwentao_adx_analysis_0113_req_trans;
drop table user_wangwentao_adx_analysis_0113_bid;
drop table user_wangwentao_adx_analysis_0113_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0114_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-01-14'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0114_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0114_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0114_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0114_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-01-14'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-01-14'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-01-14'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0114_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0114_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0114_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-01-14'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0114_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0114_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-01-14' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0114_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0114_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0114_req;
drop table user_wangwentao_adx_analysis_0114_req_trans;
drop table user_wangwentao_adx_analysis_0114_bid;
drop table user_wangwentao_adx_analysis_0114_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0115_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-01-15'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0115_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0115_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0115_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0115_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-01-15'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-01-15'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-01-15'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0115_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0115_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0115_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-01-15'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0115_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0115_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-01-15' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0115_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0115_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0115_req;
drop table user_wangwentao_adx_analysis_0115_req_trans;
drop table user_wangwentao_adx_analysis_0115_bid;
drop table user_wangwentao_adx_analysis_0115_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0116_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-01-16'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0116_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0116_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0116_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0116_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-01-16'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-01-16'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-01-16'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0116_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0116_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0116_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-01-16'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0116_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0116_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-01-16' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0116_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0116_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0116_req;
drop table user_wangwentao_adx_analysis_0116_req_trans;
drop table user_wangwentao_adx_analysis_0116_bid;
drop table user_wangwentao_adx_analysis_0116_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0117_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-01-17'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0117_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0117_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0117_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0117_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-01-17'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-01-17'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-01-17'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0117_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0117_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0117_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-01-17'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0117_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0117_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-01-17' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0117_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0117_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0117_req;
drop table user_wangwentao_adx_analysis_0117_req_trans;
drop table user_wangwentao_adx_analysis_0117_bid;
drop table user_wangwentao_adx_analysis_0117_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0118_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-01-18'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0118_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0118_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0118_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0118_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-01-18'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-01-18'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-01-18'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0118_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0118_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0118_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-01-18'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0118_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0118_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-01-18' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0118_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0118_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0118_req;
drop table user_wangwentao_adx_analysis_0118_req_trans;
drop table user_wangwentao_adx_analysis_0118_bid;
drop table user_wangwentao_adx_analysis_0118_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0119_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-01-19'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0119_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0119_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0119_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0119_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-01-19'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-01-19'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-01-19'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0119_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0119_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0119_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-01-19'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0119_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0119_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-01-19' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0119_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0119_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0119_req;
drop table user_wangwentao_adx_analysis_0119_req_trans;
drop table user_wangwentao_adx_analysis_0119_bid;
drop table user_wangwentao_adx_analysis_0119_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0120_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-01-20'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0120_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0120_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0120_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0120_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-01-20'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-01-20'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-01-20'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0120_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0120_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0120_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-01-20'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0120_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0120_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-01-20' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0120_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0120_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0120_req;
drop table user_wangwentao_adx_analysis_0120_req_trans;
drop table user_wangwentao_adx_analysis_0120_bid;
drop table user_wangwentao_adx_analysis_0120_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0121_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-01-21'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0121_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0121_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0121_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0121_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-01-21'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-01-21'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-01-21'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0121_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0121_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0121_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-01-21'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0121_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0121_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-01-21' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0121_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0121_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0121_req;
drop table user_wangwentao_adx_analysis_0121_req_trans;
drop table user_wangwentao_adx_analysis_0121_bid;
drop table user_wangwentao_adx_analysis_0121_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0122_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-01-22'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0122_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0122_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0122_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0122_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-01-22'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-01-22'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-01-22'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0122_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0122_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0122_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-01-22'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0122_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0122_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-01-22' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0122_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0122_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0122_req;
drop table user_wangwentao_adx_analysis_0122_req_trans;
drop table user_wangwentao_adx_analysis_0122_bid;
drop table user_wangwentao_adx_analysis_0122_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0123_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-01-23'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0123_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0123_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0123_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0123_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-01-23'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-01-23'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-01-23'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0123_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0123_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0123_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-01-23'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0123_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0123_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-01-23' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0123_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0123_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0123_req;
drop table user_wangwentao_adx_analysis_0123_req_trans;
drop table user_wangwentao_adx_analysis_0123_bid;
drop table user_wangwentao_adx_analysis_0123_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0124_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-01-24'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0124_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0124_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0124_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0124_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-01-24'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-01-24'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-01-24'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0124_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0124_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0124_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-01-24'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0124_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0124_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-01-24' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0124_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0124_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0124_req;
drop table user_wangwentao_adx_analysis_0124_req_trans;
drop table user_wangwentao_adx_analysis_0124_bid;
drop table user_wangwentao_adx_analysis_0124_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0125_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-01-25'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0125_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0125_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0125_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0125_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-01-25'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-01-25'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-01-25'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0125_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0125_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0125_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-01-25'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0125_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0125_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-01-25' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0125_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0125_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0125_req;
drop table user_wangwentao_adx_analysis_0125_req_trans;
drop table user_wangwentao_adx_analysis_0125_bid;
drop table user_wangwentao_adx_analysis_0125_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0126_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-01-26'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0126_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0126_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0126_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0126_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-01-26'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-01-26'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-01-26'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0126_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0126_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0126_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-01-26'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0126_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0126_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-01-26' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0126_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0126_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0126_req;
drop table user_wangwentao_adx_analysis_0126_req_trans;
drop table user_wangwentao_adx_analysis_0126_bid;
drop table user_wangwentao_adx_analysis_0126_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0127_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-01-27'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0127_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0127_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0127_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0127_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-01-27'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-01-27'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-01-27'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0127_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0127_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0127_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-01-27'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0127_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0127_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-01-27' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0127_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0127_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0127_req;
drop table user_wangwentao_adx_analysis_0127_req_trans;
drop table user_wangwentao_adx_analysis_0127_bid;
drop table user_wangwentao_adx_analysis_0127_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0128_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-01-28'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0128_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0128_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0128_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0128_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-01-28'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-01-28'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-01-28'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0128_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0128_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0128_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-01-28'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0128_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0128_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-01-28' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0128_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0128_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0128_req;
drop table user_wangwentao_adx_analysis_0128_req_trans;
drop table user_wangwentao_adx_analysis_0128_bid;
drop table user_wangwentao_adx_analysis_0128_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0129_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-01-29'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0129_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0129_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0129_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0129_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-01-29'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-01-29'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-01-29'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0129_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0129_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0129_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-01-29'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0129_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0129_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-01-29' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0129_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0129_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0129_req;
drop table user_wangwentao_adx_analysis_0129_req_trans;
drop table user_wangwentao_adx_analysis_0129_bid;
drop table user_wangwentao_adx_analysis_0129_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0130_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-01-30'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0130_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0130_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0130_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0130_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-01-30'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-01-30'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-01-30'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0130_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0130_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0130_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-01-30'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0130_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0130_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-01-30' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0130_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0130_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0130_req;
drop table user_wangwentao_adx_analysis_0130_req_trans;
drop table user_wangwentao_adx_analysis_0130_bid;
drop table user_wangwentao_adx_analysis_0130_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0131_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-01-31'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0131_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0131_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0131_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0131_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-01-31'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-01-31'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-01-31'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0131_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0131_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0131_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-01-31'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0131_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0131_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-01-31' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0131_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0131_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0131_req;
drop table user_wangwentao_adx_analysis_0131_req_trans;
drop table user_wangwentao_adx_analysis_0131_bid;
drop table user_wangwentao_adx_analysis_0131_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0201_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-02-01'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0201_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0201_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0201_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0201_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-02-01'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-02-01'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-02-01'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0201_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0201_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0201_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-02-01'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0201_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0201_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-02-01' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0201_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0201_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0201_req;
drop table user_wangwentao_adx_analysis_0201_req_trans;
drop table user_wangwentao_adx_analysis_0201_bid;
drop table user_wangwentao_adx_analysis_0201_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0202_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-02-02'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0202_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0202_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0202_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0202_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-02-02'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-02-02'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-02-02'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0202_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0202_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0202_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-02-02'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0202_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0202_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-02-02' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0202_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0202_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0202_req;
drop table user_wangwentao_adx_analysis_0202_req_trans;
drop table user_wangwentao_adx_analysis_0202_bid;
drop table user_wangwentao_adx_analysis_0202_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0203_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-02-03'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0203_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0203_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0203_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0203_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-02-03'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-02-03'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-02-03'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0203_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0203_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0203_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-02-03'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0203_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0203_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-02-03' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0203_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0203_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0203_req;
drop table user_wangwentao_adx_analysis_0203_req_trans;
drop table user_wangwentao_adx_analysis_0203_bid;
drop table user_wangwentao_adx_analysis_0203_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0204_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-02-04'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0204_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0204_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0204_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0204_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-02-04'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-02-04'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-02-04'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0204_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0204_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0204_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-02-04'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0204_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0204_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-02-04' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0204_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0204_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0204_req;
drop table user_wangwentao_adx_analysis_0204_req_trans;
drop table user_wangwentao_adx_analysis_0204_bid;
drop table user_wangwentao_adx_analysis_0204_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0205_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-02-05'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0205_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0205_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0205_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0205_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-02-05'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-02-05'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-02-05'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0205_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0205_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0205_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-02-05'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0205_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0205_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-02-05' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0205_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0205_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0205_req;
drop table user_wangwentao_adx_analysis_0205_req_trans;
drop table user_wangwentao_adx_analysis_0205_bid;
drop table user_wangwentao_adx_analysis_0205_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0206_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-02-06'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0206_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0206_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0206_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0206_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-02-06'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-02-06'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-02-06'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0206_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0206_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0206_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-02-06'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0206_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0206_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-02-06' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0206_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0206_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0206_req;
drop table user_wangwentao_adx_analysis_0206_req_trans;
drop table user_wangwentao_adx_analysis_0206_bid;
drop table user_wangwentao_adx_analysis_0206_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0207_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-02-07'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0207_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0207_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0207_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0207_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-02-07'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-02-07'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-02-07'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0207_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0207_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0207_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-02-07'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0207_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0207_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-02-07' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0207_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0207_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0207_req;
drop table user_wangwentao_adx_analysis_0207_req_trans;
drop table user_wangwentao_adx_analysis_0207_bid;
drop table user_wangwentao_adx_analysis_0207_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0208_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-02-08'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0208_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0208_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0208_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0208_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-02-08'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-02-08'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-02-08'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0208_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0208_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0208_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-02-08'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0208_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0208_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-02-08' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0208_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0208_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0208_req;
drop table user_wangwentao_adx_analysis_0208_req_trans;
drop table user_wangwentao_adx_analysis_0208_bid;
drop table user_wangwentao_adx_analysis_0208_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0209_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-02-09'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0209_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0209_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0209_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0209_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-02-09'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-02-09'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-02-09'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0209_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0209_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0209_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-02-09'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0209_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0209_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-02-09' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0209_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0209_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0209_req;
drop table user_wangwentao_adx_analysis_0209_req_trans;
drop table user_wangwentao_adx_analysis_0209_bid;
drop table user_wangwentao_adx_analysis_0209_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0210_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-02-10'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0210_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0210_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0210_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0210_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-02-10'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-02-10'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-02-10'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0210_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0210_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0210_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-02-10'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0210_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0210_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-02-10' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0210_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0210_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0210_req;
drop table user_wangwentao_adx_analysis_0210_req_trans;
drop table user_wangwentao_adx_analysis_0210_bid;
drop table user_wangwentao_adx_analysis_0210_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0211_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-02-11'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0211_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0211_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0211_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0211_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-02-11'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-02-11'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-02-11'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0211_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0211_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0211_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-02-11'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0211_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0211_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-02-11' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0211_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0211_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0211_req;
drop table user_wangwentao_adx_analysis_0211_req_trans;
drop table user_wangwentao_adx_analysis_0211_bid;
drop table user_wangwentao_adx_analysis_0211_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0212_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-02-12'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0212_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0212_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0212_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0212_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-02-12'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-02-12'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-02-12'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0212_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0212_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0212_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-02-12'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0212_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0212_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-02-12' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0212_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0212_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0212_req;
drop table user_wangwentao_adx_analysis_0212_req_trans;
drop table user_wangwentao_adx_analysis_0212_bid;
drop table user_wangwentao_adx_analysis_0212_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0213_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-02-13'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0213_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0213_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0213_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0213_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-02-13'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-02-13'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-02-13'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0213_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0213_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0213_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-02-13'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0213_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0213_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-02-13' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0213_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0213_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0213_req;
drop table user_wangwentao_adx_analysis_0213_req_trans;
drop table user_wangwentao_adx_analysis_0213_bid;
drop table user_wangwentao_adx_analysis_0213_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0214_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-02-14'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0214_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0214_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0214_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0214_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-02-14'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-02-14'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-02-14'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0214_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0214_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0214_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-02-14'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0214_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0214_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-02-14' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0214_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0214_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0214_req;
drop table user_wangwentao_adx_analysis_0214_req_trans;
drop table user_wangwentao_adx_analysis_0214_bid;
drop table user_wangwentao_adx_analysis_0214_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0215_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-02-15'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0215_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0215_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0215_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0215_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-02-15'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-02-15'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-02-15'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0215_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0215_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0215_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-02-15'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0215_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0215_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-02-15' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0215_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0215_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0215_req;
drop table user_wangwentao_adx_analysis_0215_req_trans;
drop table user_wangwentao_adx_analysis_0215_bid;
drop table user_wangwentao_adx_analysis_0215_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0216_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-02-16'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0216_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0216_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0216_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0216_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-02-16'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-02-16'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-02-16'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0216_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0216_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0216_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-02-16'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0216_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0216_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-02-16' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0216_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0216_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0216_req;
drop table user_wangwentao_adx_analysis_0216_req_trans;
drop table user_wangwentao_adx_analysis_0216_bid;
drop table user_wangwentao_adx_analysis_0216_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0217_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-02-17'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0217_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0217_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0217_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0217_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-02-17'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-02-17'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-02-17'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0217_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0217_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0217_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-02-17'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0217_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0217_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-02-17' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0217_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0217_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0217_req;
drop table user_wangwentao_adx_analysis_0217_req_trans;
drop table user_wangwentao_adx_analysis_0217_bid;
drop table user_wangwentao_adx_analysis_0217_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0218_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-02-18'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0218_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0218_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0218_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0218_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-02-18'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-02-18'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-02-18'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0218_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0218_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0218_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-02-18'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0218_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0218_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-02-18' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0218_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0218_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0218_req;
drop table user_wangwentao_adx_analysis_0218_req_trans;
drop table user_wangwentao_adx_analysis_0218_bid;
drop table user_wangwentao_adx_analysis_0218_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0219_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-02-19'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0219_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0219_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0219_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0219_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-02-19'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-02-19'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-02-19'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0219_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0219_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0219_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-02-19'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0219_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0219_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-02-19' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0219_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0219_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0219_req;
drop table user_wangwentao_adx_analysis_0219_req_trans;
drop table user_wangwentao_adx_analysis_0219_bid;
drop table user_wangwentao_adx_analysis_0219_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0220_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-02-20'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0220_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0220_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0220_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0220_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-02-20'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-02-20'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-02-20'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0220_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0220_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0220_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-02-20'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0220_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0220_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-02-20' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0220_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0220_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0220_req;
drop table user_wangwentao_adx_analysis_0220_req_trans;
drop table user_wangwentao_adx_analysis_0220_bid;
drop table user_wangwentao_adx_analysis_0220_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0221_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-02-21'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0221_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0221_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0221_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0221_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-02-21'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-02-21'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-02-21'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0221_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0221_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0221_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-02-21'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0221_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0221_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-02-21' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0221_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0221_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0221_req;
drop table user_wangwentao_adx_analysis_0221_req_trans;
drop table user_wangwentao_adx_analysis_0221_bid;
drop table user_wangwentao_adx_analysis_0221_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0222_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-02-22'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0222_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0222_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0222_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0222_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-02-22'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-02-22'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-02-22'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0222_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0222_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0222_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-02-22'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0222_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0222_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-02-22' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0222_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0222_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0222_req;
drop table user_wangwentao_adx_analysis_0222_req_trans;
drop table user_wangwentao_adx_analysis_0222_bid;
drop table user_wangwentao_adx_analysis_0222_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0223_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-02-23'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0223_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0223_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0223_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0223_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-02-23'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-02-23'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-02-23'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0223_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0223_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0223_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-02-23'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0223_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0223_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-02-23' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0223_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0223_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0223_req;
drop table user_wangwentao_adx_analysis_0223_req_trans;
drop table user_wangwentao_adx_analysis_0223_bid;
drop table user_wangwentao_adx_analysis_0223_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0224_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-02-24'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0224_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0224_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0224_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0224_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-02-24'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-02-24'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-02-24'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0224_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0224_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0224_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-02-24'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0224_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0224_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-02-24' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0224_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0224_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0224_req;
drop table user_wangwentao_adx_analysis_0224_req_trans;
drop table user_wangwentao_adx_analysis_0224_bid;
drop table user_wangwentao_adx_analysis_0224_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0225_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-02-25'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0225_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0225_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0225_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0225_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-02-25'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-02-25'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-02-25'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0225_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0225_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0225_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-02-25'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0225_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0225_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-02-25' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0225_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0225_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0225_req;
drop table user_wangwentao_adx_analysis_0225_req_trans;
drop table user_wangwentao_adx_analysis_0225_bid;
drop table user_wangwentao_adx_analysis_0225_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0226_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-02-26'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0226_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0226_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0226_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0226_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-02-26'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-02-26'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-02-26'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0226_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0226_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0226_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-02-26'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0226_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0226_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-02-26' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0226_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0226_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0226_req;
drop table user_wangwentao_adx_analysis_0226_req_trans;
drop table user_wangwentao_adx_analysis_0226_bid;
drop table user_wangwentao_adx_analysis_0226_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0227_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-02-27'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0227_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0227_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0227_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0227_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-02-27'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-02-27'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-02-27'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0227_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0227_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0227_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-02-27'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0227_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0227_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-02-27' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0227_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0227_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0227_req;
drop table user_wangwentao_adx_analysis_0227_req_trans;
drop table user_wangwentao_adx_analysis_0227_bid;
drop table user_wangwentao_adx_analysis_0227_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0228_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-02-28'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0228_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0228_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0228_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0228_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-02-28'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-02-28'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-02-28'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0228_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0228_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0228_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-02-28'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0228_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0228_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-02-28' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0228_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0228_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0228_req;
drop table user_wangwentao_adx_analysis_0228_req_trans;
drop table user_wangwentao_adx_analysis_0228_bid;
drop table user_wangwentao_adx_analysis_0228_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0301_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-01'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0301_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0301_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0301_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0301_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-01'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-03-01'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-03-01'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0301_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0301_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0301_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-03-01'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0301_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0301_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-03-01' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0301_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0301_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0301_req;
drop table user_wangwentao_adx_analysis_0301_req_trans;
drop table user_wangwentao_adx_analysis_0301_bid;
drop table user_wangwentao_adx_analysis_0301_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0302_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-02'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0302_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0302_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0302_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0302_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-02'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-03-02'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-03-02'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0302_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0302_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0302_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-03-02'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0302_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0302_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-03-02' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0302_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0302_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0302_req;
drop table user_wangwentao_adx_analysis_0302_req_trans;
drop table user_wangwentao_adx_analysis_0302_bid;
drop table user_wangwentao_adx_analysis_0302_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0303_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-03'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0303_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0303_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0303_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0303_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-03'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-03-03'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-03-03'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0303_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0303_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0303_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-03-03'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0303_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0303_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-03-03' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0303_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0303_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0303_req;
drop table user_wangwentao_adx_analysis_0303_req_trans;
drop table user_wangwentao_adx_analysis_0303_bid;
drop table user_wangwentao_adx_analysis_0303_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0304_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-04'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0304_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0304_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0304_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0304_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-04'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-03-04'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-03-04'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0304_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0304_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0304_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-03-04'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0304_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0304_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-03-04' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0304_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0304_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0304_req;
drop table user_wangwentao_adx_analysis_0304_req_trans;
drop table user_wangwentao_adx_analysis_0304_bid;
drop table user_wangwentao_adx_analysis_0304_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0305_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-05'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0305_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0305_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0305_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0305_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-05'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-03-05'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-03-05'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0305_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0305_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0305_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-03-05'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0305_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0305_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-03-05' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0305_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0305_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0305_req;
drop table user_wangwentao_adx_analysis_0305_req_trans;
drop table user_wangwentao_adx_analysis_0305_bid;
drop table user_wangwentao_adx_analysis_0305_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0306_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-06'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0306_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0306_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0306_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0306_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-06'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-03-06'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-03-06'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0306_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0306_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0306_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-03-06'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0306_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0306_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-03-06' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0306_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0306_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0306_req;
drop table user_wangwentao_adx_analysis_0306_req_trans;
drop table user_wangwentao_adx_analysis_0306_bid;
drop table user_wangwentao_adx_analysis_0306_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0307_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-07'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0307_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0307_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0307_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0307_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-07'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-03-07'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-03-07'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0307_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0307_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0307_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-03-07'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0307_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0307_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-03-07' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0307_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0307_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0307_req;
drop table user_wangwentao_adx_analysis_0307_req_trans;
drop table user_wangwentao_adx_analysis_0307_bid;
drop table user_wangwentao_adx_analysis_0307_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0308_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-08'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0308_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0308_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0308_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0308_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-08'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-03-08'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-03-08'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0308_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0308_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0308_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-03-08'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0308_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0308_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-03-08' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0308_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0308_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0308_req;
drop table user_wangwentao_adx_analysis_0308_req_trans;
drop table user_wangwentao_adx_analysis_0308_bid;
drop table user_wangwentao_adx_analysis_0308_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0309_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-09'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0309_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0309_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0309_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0309_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-09'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-03-09'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-03-09'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0309_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0309_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0309_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-03-09'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0309_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0309_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-03-09' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0309_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0309_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0309_req;
drop table user_wangwentao_adx_analysis_0309_req_trans;
drop table user_wangwentao_adx_analysis_0309_bid;
drop table user_wangwentao_adx_analysis_0309_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0310_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-10'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0310_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0310_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0310_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0310_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-10'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-03-10'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-03-10'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0310_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0310_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0310_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-03-10'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0310_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0310_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-03-10' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0310_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0310_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0310_req;
drop table user_wangwentao_adx_analysis_0310_req_trans;
drop table user_wangwentao_adx_analysis_0310_bid;
drop table user_wangwentao_adx_analysis_0310_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0311_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-11'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0311_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0311_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0311_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0311_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-11'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-03-11'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-03-11'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0311_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0311_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0311_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-03-11'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0311_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0311_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-03-11' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0311_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0311_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0311_req;
drop table user_wangwentao_adx_analysis_0311_req_trans;
drop table user_wangwentao_adx_analysis_0311_bid;
drop table user_wangwentao_adx_analysis_0311_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0312_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-12'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0312_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0312_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0312_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0312_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-12'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-03-12'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-03-12'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0312_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0312_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0312_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-03-12'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0312_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0312_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-03-12' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0312_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0312_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0312_req;
drop table user_wangwentao_adx_analysis_0312_req_trans;
drop table user_wangwentao_adx_analysis_0312_bid;
drop table user_wangwentao_adx_analysis_0312_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0313_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-13'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0313_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0313_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0313_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0313_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-13'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-03-13'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-03-13'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0313_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0313_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0313_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-03-13'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0313_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0313_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-03-13' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0313_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0313_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0313_req;
drop table user_wangwentao_adx_analysis_0313_req_trans;
drop table user_wangwentao_adx_analysis_0313_bid;
drop table user_wangwentao_adx_analysis_0313_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0314_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-14'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0314_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0314_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0314_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0314_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-14'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-03-14'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-03-14'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0314_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0314_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0314_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-03-14'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0314_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0314_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-03-14' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0314_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0314_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0314_req;
drop table user_wangwentao_adx_analysis_0314_req_trans;
drop table user_wangwentao_adx_analysis_0314_bid;
drop table user_wangwentao_adx_analysis_0314_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0315_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-15'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0315_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0315_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0315_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0315_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-15'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-03-15'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-03-15'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0315_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0315_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0315_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-03-15'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0315_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0315_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-03-15' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0315_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0315_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0315_req;
drop table user_wangwentao_adx_analysis_0315_req_trans;
drop table user_wangwentao_adx_analysis_0315_bid;
drop table user_wangwentao_adx_analysis_0315_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0316_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-16'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0316_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0316_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0316_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0316_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-16'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-03-16'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-03-16'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0316_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0316_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0316_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-03-16'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0316_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0316_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-03-16' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0316_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0316_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0316_req;
drop table user_wangwentao_adx_analysis_0316_req_trans;
drop table user_wangwentao_adx_analysis_0316_bid;
drop table user_wangwentao_adx_analysis_0316_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0317_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-17'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0317_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0317_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0317_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0317_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-17'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-03-17'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-03-17'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0317_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0317_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0317_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-03-17'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0317_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0317_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-03-17' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0317_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0317_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0317_req;
drop table user_wangwentao_adx_analysis_0317_req_trans;
drop table user_wangwentao_adx_analysis_0317_bid;
drop table user_wangwentao_adx_analysis_0317_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0318_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-18'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0318_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0318_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0318_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0318_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-18'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-03-18'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-03-18'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0318_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0318_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0318_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-03-18'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0318_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0318_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-03-18' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0318_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0318_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0318_req;
drop table user_wangwentao_adx_analysis_0318_req_trans;
drop table user_wangwentao_adx_analysis_0318_bid;
drop table user_wangwentao_adx_analysis_0318_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0319_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-19'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0319_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0319_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0319_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0319_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-19'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-03-19'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-03-19'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0319_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0319_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0319_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-03-19'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0319_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0319_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-03-19' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0319_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0319_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0319_req;
drop table user_wangwentao_adx_analysis_0319_req_trans;
drop table user_wangwentao_adx_analysis_0319_bid;
drop table user_wangwentao_adx_analysis_0319_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0320_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-20'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0320_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0320_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0320_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0320_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-20'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-03-20'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-03-20'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0320_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0320_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0320_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-03-20'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0320_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0320_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-03-20' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0320_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0320_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0320_req;
drop table user_wangwentao_adx_analysis_0320_req_trans;
drop table user_wangwentao_adx_analysis_0320_bid;
drop table user_wangwentao_adx_analysis_0320_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0321_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-21'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0321_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0321_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0321_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0321_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-21'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-03-21'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-03-21'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0321_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0321_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0321_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-03-21'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0321_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0321_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-03-21' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0321_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0321_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0321_req;
drop table user_wangwentao_adx_analysis_0321_req_trans;
drop table user_wangwentao_adx_analysis_0321_bid;
drop table user_wangwentao_adx_analysis_0321_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0322_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-22'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0322_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0322_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0322_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0322_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-22'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-03-22'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-03-22'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0322_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0322_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0322_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-03-22'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0322_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0322_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-03-22' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0322_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0322_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0322_req;
drop table user_wangwentao_adx_analysis_0322_req_trans;
drop table user_wangwentao_adx_analysis_0322_bid;
drop table user_wangwentao_adx_analysis_0322_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0323_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-23'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0323_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0323_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0323_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0323_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-23'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-03-23'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-03-23'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0323_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0323_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0323_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-03-23'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0323_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0323_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-03-23' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0323_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0323_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0323_req;
drop table user_wangwentao_adx_analysis_0323_req_trans;
drop table user_wangwentao_adx_analysis_0323_bid;
drop table user_wangwentao_adx_analysis_0323_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0324_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-24'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0324_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0324_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0324_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0324_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-24'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-03-24'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-03-24'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0324_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0324_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0324_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-03-24'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0324_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0324_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-03-24' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0324_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0324_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0324_req;
drop table user_wangwentao_adx_analysis_0324_req_trans;
drop table user_wangwentao_adx_analysis_0324_bid;
drop table user_wangwentao_adx_analysis_0324_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0325_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-25'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0325_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0325_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0325_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0325_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-25'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-03-25'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-03-25'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0325_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0325_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0325_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-03-25'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0325_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0325_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-03-25' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0325_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0325_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0325_req;
drop table user_wangwentao_adx_analysis_0325_req_trans;
drop table user_wangwentao_adx_analysis_0325_bid;
drop table user_wangwentao_adx_analysis_0325_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0326_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-26'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0326_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0326_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0326_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0326_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-26'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-03-26'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-03-26'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0326_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0326_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0326_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-03-26'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0326_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0326_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-03-26' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0326_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0326_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0326_req;
drop table user_wangwentao_adx_analysis_0326_req_trans;
drop table user_wangwentao_adx_analysis_0326_bid;
drop table user_wangwentao_adx_analysis_0326_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0327_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-27'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0327_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0327_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0327_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0327_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-27'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-03-27'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-03-27'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0327_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0327_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0327_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-03-27'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0327_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0327_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-03-27' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0327_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0327_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0327_req;
drop table user_wangwentao_adx_analysis_0327_req_trans;
drop table user_wangwentao_adx_analysis_0327_bid;
drop table user_wangwentao_adx_analysis_0327_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0328_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-28'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0328_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0328_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0328_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0328_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-28'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-03-28'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-03-28'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0328_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0328_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0328_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-03-28'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0328_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0328_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-03-28' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0328_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0328_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0328_req;
drop table user_wangwentao_adx_analysis_0328_req_trans;
drop table user_wangwentao_adx_analysis_0328_bid;
drop table user_wangwentao_adx_analysis_0328_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0329_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-29'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0329_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0329_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0329_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0329_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-29'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-03-29'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-03-29'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0329_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0329_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0329_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-03-29'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0329_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0329_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-03-29' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0329_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0329_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0329_req;
drop table user_wangwentao_adx_analysis_0329_req_trans;
drop table user_wangwentao_adx_analysis_0329_bid;
drop table user_wangwentao_adx_analysis_0329_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0330_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-30'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0330_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0330_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0330_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0330_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-30'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-03-30'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-03-30'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0330_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0330_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0330_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-03-30'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0330_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0330_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-03-30' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0330_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0330_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0330_req;
drop table user_wangwentao_adx_analysis_0330_req_trans;
drop table user_wangwentao_adx_analysis_0330_bid;
drop table user_wangwentao_adx_analysis_0330_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0331_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-31'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0331_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0331_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0331_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0331_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-03-31'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-03-31'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-03-31'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0331_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0331_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0331_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-03-31'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0331_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0331_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-03-31' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0331_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0331_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0331_req;
drop table user_wangwentao_adx_analysis_0331_req_trans;
drop table user_wangwentao_adx_analysis_0331_bid;
drop table user_wangwentao_adx_analysis_0331_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0401_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-01'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0401_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0401_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0401_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0401_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-01'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-04-01'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-04-01'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0401_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0401_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0401_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-04-01'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0401_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0401_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-04-01' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0401_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0401_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0401_req;
drop table user_wangwentao_adx_analysis_0401_req_trans;
drop table user_wangwentao_adx_analysis_0401_bid;
drop table user_wangwentao_adx_analysis_0401_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0402_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-02'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0402_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0402_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0402_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0402_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-02'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-04-02'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-04-02'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0402_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0402_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0402_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-04-02'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0402_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0402_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-04-02' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0402_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0402_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0402_req;
drop table user_wangwentao_adx_analysis_0402_req_trans;
drop table user_wangwentao_adx_analysis_0402_bid;
drop table user_wangwentao_adx_analysis_0402_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0403_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-03'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0403_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0403_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0403_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0403_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-03'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-04-03'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-04-03'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0403_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0403_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0403_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-04-03'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0403_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0403_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-04-03' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0403_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0403_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0403_req;
drop table user_wangwentao_adx_analysis_0403_req_trans;
drop table user_wangwentao_adx_analysis_0403_bid;
drop table user_wangwentao_adx_analysis_0403_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0404_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-04'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0404_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0404_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0404_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0404_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-04'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-04-04'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-04-04'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0404_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0404_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0404_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-04-04'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0404_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0404_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-04-04' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0404_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0404_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0404_req;
drop table user_wangwentao_adx_analysis_0404_req_trans;
drop table user_wangwentao_adx_analysis_0404_bid;
drop table user_wangwentao_adx_analysis_0404_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0405_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-05'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0405_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0405_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0405_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0405_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-05'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-04-05'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-04-05'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0405_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0405_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0405_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-04-05'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0405_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0405_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-04-05' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0405_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0405_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0405_req;
drop table user_wangwentao_adx_analysis_0405_req_trans;
drop table user_wangwentao_adx_analysis_0405_bid;
drop table user_wangwentao_adx_analysis_0405_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0406_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-06'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0406_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0406_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0406_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0406_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-06'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-04-06'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-04-06'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0406_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0406_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0406_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-04-06'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0406_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0406_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-04-06' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0406_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0406_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0406_req;
drop table user_wangwentao_adx_analysis_0406_req_trans;
drop table user_wangwentao_adx_analysis_0406_bid;
drop table user_wangwentao_adx_analysis_0406_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0407_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-07'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0407_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0407_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0407_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0407_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-07'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-04-07'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-04-07'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0407_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0407_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0407_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-04-07'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0407_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0407_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-04-07' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0407_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0407_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0407_req;
drop table user_wangwentao_adx_analysis_0407_req_trans;
drop table user_wangwentao_adx_analysis_0407_bid;
drop table user_wangwentao_adx_analysis_0407_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0408_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-08'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0408_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0408_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0408_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0408_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-08'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-04-08'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-04-08'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0408_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0408_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0408_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-04-08'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0408_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0408_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-04-08' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0408_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0408_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0408_req;
drop table user_wangwentao_adx_analysis_0408_req_trans;
drop table user_wangwentao_adx_analysis_0408_bid;
drop table user_wangwentao_adx_analysis_0408_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0409_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-09'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0409_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0409_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0409_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0409_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-09'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-04-09'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-04-09'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0409_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0409_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0409_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-04-09'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0409_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0409_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-04-09' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0409_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0409_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0409_req;
drop table user_wangwentao_adx_analysis_0409_req_trans;
drop table user_wangwentao_adx_analysis_0409_bid;
drop table user_wangwentao_adx_analysis_0409_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0410_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-10'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0410_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0410_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0410_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0410_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-10'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-04-10'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-04-10'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0410_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0410_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0410_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-04-10'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0410_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0410_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-04-10' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0410_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0410_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0410_req;
drop table user_wangwentao_adx_analysis_0410_req_trans;
drop table user_wangwentao_adx_analysis_0410_bid;
drop table user_wangwentao_adx_analysis_0410_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0411_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-11'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0411_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0411_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0411_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0411_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-11'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-04-11'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-04-11'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0411_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0411_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0411_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-04-11'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0411_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0411_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-04-11' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0411_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0411_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0411_req;
drop table user_wangwentao_adx_analysis_0411_req_trans;
drop table user_wangwentao_adx_analysis_0411_bid;
drop table user_wangwentao_adx_analysis_0411_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0412_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-12'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0412_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0412_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0412_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0412_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-12'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-04-12'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-04-12'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0412_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0412_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0412_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-04-12'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0412_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0412_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-04-12' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0412_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0412_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0412_req;
drop table user_wangwentao_adx_analysis_0412_req_trans;
drop table user_wangwentao_adx_analysis_0412_bid;
drop table user_wangwentao_adx_analysis_0412_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0413_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-13'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0413_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0413_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0413_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0413_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-13'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-04-13'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-04-13'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0413_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0413_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0413_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-04-13'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0413_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0413_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-04-13' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0413_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0413_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0413_req;
drop table user_wangwentao_adx_analysis_0413_req_trans;
drop table user_wangwentao_adx_analysis_0413_bid;
drop table user_wangwentao_adx_analysis_0413_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0414_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-14'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0414_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0414_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0414_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0414_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-14'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-04-14'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-04-14'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0414_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0414_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0414_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-04-14'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0414_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0414_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-04-14' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0414_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0414_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0414_req;
drop table user_wangwentao_adx_analysis_0414_req_trans;
drop table user_wangwentao_adx_analysis_0414_bid;
drop table user_wangwentao_adx_analysis_0414_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0415_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-15'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0415_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0415_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0415_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0415_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-15'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-04-15'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-04-15'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0415_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0415_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0415_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-04-15'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0415_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0415_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-04-15' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0415_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0415_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0415_req;
drop table user_wangwentao_adx_analysis_0415_req_trans;
drop table user_wangwentao_adx_analysis_0415_bid;
drop table user_wangwentao_adx_analysis_0415_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0416_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-16'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0416_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0416_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0416_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0416_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-16'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-04-16'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-04-16'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0416_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0416_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0416_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-04-16'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0416_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0416_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-04-16' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0416_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0416_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0416_req;
drop table user_wangwentao_adx_analysis_0416_req_trans;
drop table user_wangwentao_adx_analysis_0416_bid;
drop table user_wangwentao_adx_analysis_0416_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0417_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-17'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0417_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0417_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0417_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0417_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-17'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-04-17'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-04-17'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0417_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0417_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0417_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-04-17'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0417_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0417_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-04-17' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0417_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0417_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0417_req;
drop table user_wangwentao_adx_analysis_0417_req_trans;
drop table user_wangwentao_adx_analysis_0417_bid;
drop table user_wangwentao_adx_analysis_0417_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0418_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-18'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0418_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0418_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0418_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0418_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-18'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-04-18'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-04-18'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0418_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0418_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0418_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-04-18'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0418_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0418_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-04-18' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0418_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0418_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0418_req;
drop table user_wangwentao_adx_analysis_0418_req_trans;
drop table user_wangwentao_adx_analysis_0418_bid;
drop table user_wangwentao_adx_analysis_0418_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0419_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-19'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0419_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0419_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0419_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0419_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-19'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-04-19'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-04-19'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0419_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0419_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0419_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-04-19'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0419_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0419_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-04-19' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0419_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0419_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0419_req;
drop table user_wangwentao_adx_analysis_0419_req_trans;
drop table user_wangwentao_adx_analysis_0419_bid;
drop table user_wangwentao_adx_analysis_0419_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0420_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-20'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0420_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0420_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0420_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0420_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-20'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-04-20'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-04-20'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0420_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0420_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0420_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-04-20'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0420_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0420_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-04-20' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0420_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0420_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0420_req;
drop table user_wangwentao_adx_analysis_0420_req_trans;
drop table user_wangwentao_adx_analysis_0420_bid;
drop table user_wangwentao_adx_analysis_0420_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0421_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-21'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0421_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0421_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0421_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0421_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-21'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-04-21'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-04-21'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0421_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0421_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0421_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-04-21'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0421_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0421_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-04-21' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0421_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0421_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0421_req;
drop table user_wangwentao_adx_analysis_0421_req_trans;
drop table user_wangwentao_adx_analysis_0421_bid;
drop table user_wangwentao_adx_analysis_0421_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0422_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-22'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0422_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0422_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0422_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0422_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-22'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-04-22'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-04-22'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0422_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0422_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0422_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-04-22'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0422_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0422_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-04-22' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0422_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0422_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0422_req;
drop table user_wangwentao_adx_analysis_0422_req_trans;
drop table user_wangwentao_adx_analysis_0422_bid;
drop table user_wangwentao_adx_analysis_0422_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0423_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-23'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0423_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0423_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0423_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0423_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-23'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-04-23'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-04-23'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0423_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0423_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0423_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-04-23'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0423_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0423_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-04-23' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0423_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0423_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0423_req;
drop table user_wangwentao_adx_analysis_0423_req_trans;
drop table user_wangwentao_adx_analysis_0423_bid;
drop table user_wangwentao_adx_analysis_0423_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0424_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-24'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0424_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0424_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0424_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0424_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-24'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-04-24'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-04-24'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0424_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0424_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0424_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-04-24'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0424_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0424_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-04-24' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0424_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0424_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0424_req;
drop table user_wangwentao_adx_analysis_0424_req_trans;
drop table user_wangwentao_adx_analysis_0424_bid;
drop table user_wangwentao_adx_analysis_0424_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0425_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-25'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0425_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0425_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0425_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0425_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-25'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-04-25'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-04-25'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0425_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0425_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0425_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-04-25'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0425_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0425_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-04-25' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0425_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0425_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0425_req;
drop table user_wangwentao_adx_analysis_0425_req_trans;
drop table user_wangwentao_adx_analysis_0425_bid;
drop table user_wangwentao_adx_analysis_0425_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0426_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-26'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0426_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0426_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0426_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0426_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-26'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-04-26'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-04-26'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0426_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0426_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0426_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-04-26'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0426_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0426_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-04-26' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0426_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0426_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0426_req;
drop table user_wangwentao_adx_analysis_0426_req_trans;
drop table user_wangwentao_adx_analysis_0426_bid;
drop table user_wangwentao_adx_analysis_0426_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0427_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-27'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0427_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0427_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0427_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0427_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-27'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-04-27'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-04-27'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0427_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0427_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0427_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-04-27'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0427_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0427_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-04-27' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0427_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0427_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0427_req;
drop table user_wangwentao_adx_analysis_0427_req_trans;
drop table user_wangwentao_adx_analysis_0427_bid;
drop table user_wangwentao_adx_analysis_0427_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0428_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-28'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0428_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0428_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0428_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0428_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-28'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-04-28'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-04-28'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0428_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0428_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0428_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-04-28'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0428_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0428_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-04-28' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0428_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0428_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0428_req;
drop table user_wangwentao_adx_analysis_0428_req_trans;
drop table user_wangwentao_adx_analysis_0428_bid;
drop table user_wangwentao_adx_analysis_0428_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0429_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-29'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0429_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0429_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0429_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0429_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-29'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-04-29'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-04-29'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0429_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0429_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0429_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-04-29'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0429_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0429_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-04-29' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0429_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0429_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0429_req;
drop table user_wangwentao_adx_analysis_0429_req_trans;
drop table user_wangwentao_adx_analysis_0429_bid;
drop table user_wangwentao_adx_analysis_0429_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0430_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-30'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0430_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0430_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0430_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0430_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-04-30'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-04-30'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-04-30'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0430_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0430_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0430_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-04-30'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0430_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0430_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-04-30' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0430_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0430_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0430_req;
drop table user_wangwentao_adx_analysis_0430_req_trans;
drop table user_wangwentao_adx_analysis_0430_bid;
drop table user_wangwentao_adx_analysis_0430_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0501_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-01'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0501_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0501_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0501_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0501_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-01'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-05-01'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-05-01'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0501_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0501_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0501_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-05-01'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0501_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0501_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-05-01' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0501_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0501_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0501_req;
drop table user_wangwentao_adx_analysis_0501_req_trans;
drop table user_wangwentao_adx_analysis_0501_bid;
drop table user_wangwentao_adx_analysis_0501_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0502_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-02'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0502_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0502_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0502_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0502_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-02'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-05-02'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-05-02'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0502_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0502_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0502_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-05-02'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0502_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0502_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-05-02' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0502_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0502_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0502_req;
drop table user_wangwentao_adx_analysis_0502_req_trans;
drop table user_wangwentao_adx_analysis_0502_bid;
drop table user_wangwentao_adx_analysis_0502_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0503_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-03'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0503_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0503_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0503_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0503_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-03'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-05-03'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-05-03'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0503_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0503_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0503_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-05-03'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0503_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0503_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-05-03' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0503_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0503_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0503_req;
drop table user_wangwentao_adx_analysis_0503_req_trans;
drop table user_wangwentao_adx_analysis_0503_bid;
drop table user_wangwentao_adx_analysis_0503_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0504_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-04'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0504_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0504_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0504_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0504_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-04'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-05-04'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-05-04'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0504_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0504_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0504_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-05-04'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0504_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0504_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-05-04' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0504_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0504_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0504_req;
drop table user_wangwentao_adx_analysis_0504_req_trans;
drop table user_wangwentao_adx_analysis_0504_bid;
drop table user_wangwentao_adx_analysis_0504_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0505_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-05'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0505_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0505_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0505_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0505_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-05'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-05-05'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-05-05'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0505_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0505_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0505_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-05-05'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0505_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0505_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-05-05' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0505_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0505_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0505_req;
drop table user_wangwentao_adx_analysis_0505_req_trans;
drop table user_wangwentao_adx_analysis_0505_bid;
drop table user_wangwentao_adx_analysis_0505_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0506_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-06'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0506_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0506_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0506_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0506_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-06'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-05-06'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-05-06'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0506_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0506_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0506_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-05-06'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0506_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0506_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-05-06' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0506_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0506_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0506_req;
drop table user_wangwentao_adx_analysis_0506_req_trans;
drop table user_wangwentao_adx_analysis_0506_bid;
drop table user_wangwentao_adx_analysis_0506_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0507_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-07'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0507_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0507_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0507_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0507_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-07'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-05-07'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-05-07'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0507_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0507_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0507_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-05-07'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0507_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0507_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-05-07' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0507_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0507_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0507_req;
drop table user_wangwentao_adx_analysis_0507_req_trans;
drop table user_wangwentao_adx_analysis_0507_bid;
drop table user_wangwentao_adx_analysis_0507_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0508_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-08'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0508_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0508_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0508_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0508_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-08'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-05-08'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-05-08'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0508_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0508_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0508_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-05-08'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0508_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0508_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-05-08' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0508_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0508_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0508_req;
drop table user_wangwentao_adx_analysis_0508_req_trans;
drop table user_wangwentao_adx_analysis_0508_bid;
drop table user_wangwentao_adx_analysis_0508_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0509_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-09'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0509_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0509_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0509_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0509_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-09'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-05-09'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-05-09'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0509_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0509_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0509_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-05-09'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0509_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0509_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-05-09' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0509_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0509_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0509_req;
drop table user_wangwentao_adx_analysis_0509_req_trans;
drop table user_wangwentao_adx_analysis_0509_bid;
drop table user_wangwentao_adx_analysis_0509_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0510_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-10'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0510_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0510_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0510_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0510_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-10'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-05-10'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-05-10'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0510_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0510_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0510_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-05-10'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0510_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0510_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-05-10' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0510_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0510_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0510_req;
drop table user_wangwentao_adx_analysis_0510_req_trans;
drop table user_wangwentao_adx_analysis_0510_bid;
drop table user_wangwentao_adx_analysis_0510_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0511_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-11'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0511_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0511_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0511_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0511_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-11'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-05-11'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-05-11'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0511_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0511_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0511_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-05-11'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0511_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0511_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-05-11' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0511_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0511_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0511_req;
drop table user_wangwentao_adx_analysis_0511_req_trans;
drop table user_wangwentao_adx_analysis_0511_bid;
drop table user_wangwentao_adx_analysis_0511_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0512_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-12'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0512_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0512_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0512_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0512_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-12'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-05-12'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-05-12'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0512_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0512_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0512_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-05-12'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0512_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0512_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-05-12' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0512_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0512_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0512_req;
drop table user_wangwentao_adx_analysis_0512_req_trans;
drop table user_wangwentao_adx_analysis_0512_bid;
drop table user_wangwentao_adx_analysis_0512_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0513_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-13'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0513_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0513_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0513_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0513_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-13'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-05-13'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-05-13'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0513_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0513_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0513_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-05-13'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0513_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0513_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-05-13' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0513_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0513_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0513_req;
drop table user_wangwentao_adx_analysis_0513_req_trans;
drop table user_wangwentao_adx_analysis_0513_bid;
drop table user_wangwentao_adx_analysis_0513_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0514_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-14'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0514_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0514_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0514_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0514_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-14'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-05-14'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-05-14'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0514_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0514_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0514_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-05-14'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0514_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0514_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-05-14' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0514_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0514_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0514_req;
drop table user_wangwentao_adx_analysis_0514_req_trans;
drop table user_wangwentao_adx_analysis_0514_bid;
drop table user_wangwentao_adx_analysis_0514_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0515_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-15'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0515_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0515_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0515_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0515_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-15'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-05-15'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-05-15'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0515_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0515_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0515_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-05-15'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0515_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0515_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-05-15' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0515_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0515_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0515_req;
drop table user_wangwentao_adx_analysis_0515_req_trans;
drop table user_wangwentao_adx_analysis_0515_bid;
drop table user_wangwentao_adx_analysis_0515_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0516_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-16'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0516_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0516_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0516_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0516_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-16'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-05-16'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-05-16'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0516_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0516_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0516_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-05-16'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0516_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0516_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-05-16' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0516_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0516_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0516_req;
drop table user_wangwentao_adx_analysis_0516_req_trans;
drop table user_wangwentao_adx_analysis_0516_bid;
drop table user_wangwentao_adx_analysis_0516_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0517_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-17'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0517_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0517_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0517_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0517_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-17'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-05-17'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-05-17'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0517_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0517_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0517_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-05-17'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0517_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0517_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-05-17' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0517_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0517_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0517_req;
drop table user_wangwentao_adx_analysis_0517_req_trans;
drop table user_wangwentao_adx_analysis_0517_bid;
drop table user_wangwentao_adx_analysis_0517_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0518_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-18'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0518_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0518_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0518_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0518_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-18'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-05-18'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-05-18'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0518_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0518_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0518_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-05-18'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0518_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0518_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-05-18' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0518_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0518_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0518_req;
drop table user_wangwentao_adx_analysis_0518_req_trans;
drop table user_wangwentao_adx_analysis_0518_bid;
drop table user_wangwentao_adx_analysis_0518_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0519_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-19'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0519_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0519_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0519_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0519_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-19'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-05-19'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-05-19'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0519_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0519_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0519_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-05-19'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0519_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0519_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-05-19' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0519_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0519_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0519_req;
drop table user_wangwentao_adx_analysis_0519_req_trans;
drop table user_wangwentao_adx_analysis_0519_bid;
drop table user_wangwentao_adx_analysis_0519_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0520_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-20'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0520_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0520_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0520_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0520_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-20'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-05-20'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-05-20'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0520_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0520_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0520_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-05-20'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0520_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0520_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-05-20' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0520_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0520_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0520_req;
drop table user_wangwentao_adx_analysis_0520_req_trans;
drop table user_wangwentao_adx_analysis_0520_bid;
drop table user_wangwentao_adx_analysis_0520_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0521_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-21'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0521_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0521_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0521_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0521_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-21'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-05-21'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-05-21'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0521_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0521_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0521_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-05-21'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0521_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0521_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-05-21' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0521_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0521_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0521_req;
drop table user_wangwentao_adx_analysis_0521_req_trans;
drop table user_wangwentao_adx_analysis_0521_bid;
drop table user_wangwentao_adx_analysis_0521_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0522_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-22'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0522_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0522_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0522_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0522_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-22'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-05-22'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-05-22'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0522_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0522_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0522_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-05-22'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0522_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0522_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-05-22' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0522_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0522_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0522_req;
drop table user_wangwentao_adx_analysis_0522_req_trans;
drop table user_wangwentao_adx_analysis_0522_bid;
drop table user_wangwentao_adx_analysis_0522_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0523_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-23'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0523_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0523_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0523_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0523_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-23'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-05-23'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-05-23'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0523_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0523_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0523_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-05-23'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0523_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0523_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-05-23' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0523_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0523_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0523_req;
drop table user_wangwentao_adx_analysis_0523_req_trans;
drop table user_wangwentao_adx_analysis_0523_bid;
drop table user_wangwentao_adx_analysis_0523_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0524_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-24'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0524_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0524_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0524_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0524_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-24'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-05-24'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-05-24'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0524_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0524_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0524_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-05-24'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0524_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0524_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-05-24' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0524_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0524_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0524_req;
drop table user_wangwentao_adx_analysis_0524_req_trans;
drop table user_wangwentao_adx_analysis_0524_bid;
drop table user_wangwentao_adx_analysis_0524_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0525_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-25'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0525_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0525_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0525_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0525_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-25'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-05-25'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-05-25'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0525_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0525_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0525_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-05-25'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0525_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0525_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-05-25' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0525_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0525_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0525_req;
drop table user_wangwentao_adx_analysis_0525_req_trans;
drop table user_wangwentao_adx_analysis_0525_bid;
drop table user_wangwentao_adx_analysis_0525_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0526_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-26'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0526_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0526_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0526_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0526_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-26'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-05-26'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-05-26'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0526_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0526_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0526_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-05-26'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0526_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0526_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-05-26' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0526_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0526_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0526_req;
drop table user_wangwentao_adx_analysis_0526_req_trans;
drop table user_wangwentao_adx_analysis_0526_bid;
drop table user_wangwentao_adx_analysis_0526_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0527_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-27'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0527_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0527_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0527_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0527_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-27'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-05-27'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-05-27'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0527_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0527_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0527_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-05-27'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0527_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0527_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-05-27' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0527_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0527_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0527_req;
drop table user_wangwentao_adx_analysis_0527_req_trans;
drop table user_wangwentao_adx_analysis_0527_bid;
drop table user_wangwentao_adx_analysis_0527_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0528_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-28'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0528_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0528_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0528_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0528_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-28'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-05-28'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-05-28'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0528_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0528_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0528_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-05-28'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0528_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0528_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-05-28' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0528_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0528_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0528_req;
drop table user_wangwentao_adx_analysis_0528_req_trans;
drop table user_wangwentao_adx_analysis_0528_bid;
drop table user_wangwentao_adx_analysis_0528_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0529_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-29'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0529_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0529_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0529_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0529_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-29'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-05-29'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-05-29'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0529_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0529_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0529_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-05-29'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0529_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0529_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-05-29' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0529_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0529_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0529_req;
drop table user_wangwentao_adx_analysis_0529_req_trans;
drop table user_wangwentao_adx_analysis_0529_bid;
drop table user_wangwentao_adx_analysis_0529_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0530_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-30'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0530_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0530_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0530_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0530_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-30'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-05-30'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-05-30'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0530_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0530_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0530_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-05-30'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0530_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0530_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-05-30' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0530_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0530_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0530_req;
drop table user_wangwentao_adx_analysis_0530_req_trans;
drop table user_wangwentao_adx_analysis_0530_bid;
drop table user_wangwentao_adx_analysis_0530_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0531_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-31'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0531_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0531_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0531_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0531_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-05-31'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-05-31'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-05-31'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0531_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0531_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0531_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-05-31'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0531_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0531_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-05-31' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0531_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0531_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0531_req;
drop table user_wangwentao_adx_analysis_0531_req_trans;
drop table user_wangwentao_adx_analysis_0531_bid;
drop table user_wangwentao_adx_analysis_0531_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0601_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-06-01'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0601_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0601_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0601_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0601_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-06-01'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-06-01'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-06-01'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0601_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0601_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0601_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-06-01'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0601_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0601_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-06-01' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0601_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0601_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0601_req;
drop table user_wangwentao_adx_analysis_0601_req_trans;
drop table user_wangwentao_adx_analysis_0601_bid;
drop table user_wangwentao_adx_analysis_0601_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0602_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-06-02'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0602_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0602_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0602_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0602_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-06-02'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-06-02'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-06-02'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0602_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0602_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0602_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-06-02'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0602_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0602_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-06-02' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0602_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0602_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0602_req;
drop table user_wangwentao_adx_analysis_0602_req_trans;
drop table user_wangwentao_adx_analysis_0602_bid;
drop table user_wangwentao_adx_analysis_0602_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0603_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-06-03'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0603_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0603_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0603_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0603_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-06-03'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-06-03'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-06-03'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0603_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0603_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0603_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-06-03'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0603_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0603_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-06-03' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0603_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0603_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0603_req;
drop table user_wangwentao_adx_analysis_0603_req_trans;
drop table user_wangwentao_adx_analysis_0603_bid;
drop table user_wangwentao_adx_analysis_0603_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0604_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-06-04'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0604_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0604_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0604_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0604_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-06-04'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-06-04'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-06-04'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0604_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0604_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0604_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-06-04'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0604_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0604_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-06-04' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0604_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0604_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0604_req;
drop table user_wangwentao_adx_analysis_0604_req_trans;
drop table user_wangwentao_adx_analysis_0604_bid;
drop table user_wangwentao_adx_analysis_0604_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0605_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-06-05'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0605_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0605_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0605_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0605_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-06-05'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-06-05'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-06-05'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0605_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0605_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0605_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-06-05'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0605_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0605_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-06-05' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0605_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0605_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0605_req;
drop table user_wangwentao_adx_analysis_0605_req_trans;
drop table user_wangwentao_adx_analysis_0605_bid;
drop table user_wangwentao_adx_analysis_0605_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0606_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-06-06'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0606_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0606_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0606_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0606_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-06-06'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-06-06'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-06-06'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0606_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0606_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0606_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-06-06'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0606_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0606_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-06-06' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0606_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0606_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0606_req;
drop table user_wangwentao_adx_analysis_0606_req_trans;
drop table user_wangwentao_adx_analysis_0606_bid;
drop table user_wangwentao_adx_analysis_0606_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0607_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-06-07'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0607_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0607_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0607_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0607_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-06-07'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-06-07'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-06-07'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0607_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0607_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0607_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-06-07'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0607_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0607_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-06-07' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0607_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0607_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0607_req;
drop table user_wangwentao_adx_analysis_0607_req_trans;
drop table user_wangwentao_adx_analysis_0607_bid;
drop table user_wangwentao_adx_analysis_0607_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0608_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-06-08'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0608_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0608_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0608_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0608_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-06-08'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-06-08'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-06-08'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0608_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0608_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0608_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-06-08'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0608_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0608_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-06-08' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0608_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0608_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0608_req;
drop table user_wangwentao_adx_analysis_0608_req_trans;
drop table user_wangwentao_adx_analysis_0608_bid;
drop table user_wangwentao_adx_analysis_0608_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0609_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-06-09'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0609_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0609_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0609_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0609_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-06-09'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-06-09'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-06-09'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0609_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0609_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0609_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-06-09'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0609_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0609_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-06-09' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0609_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0609_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0609_req;
drop table user_wangwentao_adx_analysis_0609_req_trans;
drop table user_wangwentao_adx_analysis_0609_bid;
drop table user_wangwentao_adx_analysis_0609_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0610_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-06-10'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0610_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0610_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0610_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0610_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-06-10'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-06-10'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-06-10'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0610_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0610_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0610_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-06-10'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0610_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0610_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-06-10' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0610_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0610_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0610_req;
drop table user_wangwentao_adx_analysis_0610_req_trans;
drop table user_wangwentao_adx_analysis_0610_bid;
drop table user_wangwentao_adx_analysis_0610_bid_trans;
"
