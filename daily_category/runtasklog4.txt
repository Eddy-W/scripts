hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0101_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-01-01'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0101_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0101_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0101_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0101_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-01-01'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-01-01'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-01-01'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0101_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0101_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0101_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-01-01'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0101_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0101_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-01-01' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0101_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0101_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0101_req;
drop table user_wangwentao_adx_analysis_0101_req_trans;
drop table user_wangwentao_adx_analysis_0101_bid;
drop table user_wangwentao_adx_analysis_0101_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0102_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-01-02'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0102_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0102_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0102_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0102_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-01-02'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-01-02'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-01-02'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0102_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0102_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0102_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-01-02'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0102_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0102_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-01-02' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0102_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0102_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0102_req;
drop table user_wangwentao_adx_analysis_0102_req_trans;
drop table user_wangwentao_adx_analysis_0102_bid;
drop table user_wangwentao_adx_analysis_0102_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0103_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-01-03'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0103_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0103_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0103_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0103_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-01-03'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-01-03'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-01-03'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0103_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0103_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0103_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-01-03'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0103_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0103_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-01-03' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0103_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0103_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0103_req;
drop table user_wangwentao_adx_analysis_0103_req_trans;
drop table user_wangwentao_adx_analysis_0103_bid;
drop table user_wangwentao_adx_analysis_0103_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0104_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-01-04'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0104_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0104_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0104_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0104_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-01-04'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-01-04'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-01-04'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0104_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0104_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0104_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-01-04'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0104_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0104_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-01-04' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0104_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0104_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0104_req;
drop table user_wangwentao_adx_analysis_0104_req_trans;
drop table user_wangwentao_adx_analysis_0104_bid;
drop table user_wangwentao_adx_analysis_0104_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0105_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-01-05'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0105_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0105_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0105_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0105_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-01-05'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-01-05'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-01-05'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0105_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0105_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0105_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-01-05'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0105_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0105_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-01-05' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0105_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0105_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0105_req;
drop table user_wangwentao_adx_analysis_0105_req_trans;
drop table user_wangwentao_adx_analysis_0105_bid;
drop table user_wangwentao_adx_analysis_0105_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0106_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-01-06'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0106_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0106_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0106_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0106_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-01-06'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-01-06'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-01-06'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0106_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0106_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0106_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-01-06'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0106_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0106_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-01-06' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0106_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0106_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0106_req;
drop table user_wangwentao_adx_analysis_0106_req_trans;
drop table user_wangwentao_adx_analysis_0106_bid;
drop table user_wangwentao_adx_analysis_0106_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0107_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-01-07'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0107_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0107_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0107_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0107_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-01-07'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-01-07'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-01-07'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0107_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0107_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0107_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-01-07'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0107_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0107_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-01-07' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0107_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0107_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0107_req;
drop table user_wangwentao_adx_analysis_0107_req_trans;
drop table user_wangwentao_adx_analysis_0107_bid;
drop table user_wangwentao_adx_analysis_0107_bid_trans;
"
hive -e "
add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists  user_wangwentao_adx_analysis_0108_req  as
select 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
 
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-01-08'  and raw_log.exchange_id=2
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0108_req_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg
from
(select geoid,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0108_req)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0108_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e "

add jar allyes-hive-udf-1.4.0.jar; 
create temporary function url2domain as 'com.allyes.hive.udf.Url2domain';

create table if not exists user_wangwentao_adx_analysis_0108_bid as
select bid_t.geoid,bid_t.domain,
bid_t.sz,
bid_t.bidfloor bidfloor,
bid_t.cateid,bid_t.cateweg,
bid_t.bidprice bidprice,
if(show_t.impid is null, 0,1) imptag,
if(show_t.winprice is null,0,show_t.winprice) winprice,
if(clk_t.impid is null, 0,1) clktag
from
(
select 
 
raw_log.impression_id as impid,  
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.geo_criteria_id') as geoid,
url2domain(raw_log.referrer,get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.platform'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.mobile.app_id'),
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.anonymous_id')) domain,
ifcbids.price_bid bidprice,
ifcbids.price_bidfloor bidfloor,
concat(ifcbids.adslot_width,'x',ifcbids.adslot_height,':',
lower(get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.adslot[0].slot_visibility'))) as sz,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.id') as cateid,
get_json_object(bidrequest(raw_log.post_data_type,raw_log.post_data), '$.detected_vertical.weight') as cateweg
from pb_ifc_bidlog
where  dd='2014-01-08'  and raw_log.exchange_id=2 and ifcbids.price_bid>0
)bid_t
LEFT OUTER JOIN
(
select 
dd,
saw_log.raw_log.selling_price as winprice, saw_log.raw_log.impression_id as impid
from
pb_showlog
where product='ifc' and db='ifc' and  dd='2014-01-08'  and saw_log.raw_log.exchange_id=2
)show_t ON(bid_t.impid=show_t.impid)
LEFT OUTER JOIN
(
select  
dd,
saw_log.raw_log.impression_id as impid
from
pb_clicklog
where product='ifc' and db='ifc' and  dd='2014-01-08'  and saw_log.raw_log.exchange_id=2
)clk_t ON(show_t.impid = clk_t.impid)
"
hive -e "
create table if not exists  user_wangwentao_adx_analysis_0108_bid_trans  as
select
geomapt.province,if(domainnstopt.domain is null,'other',domainnstopt.domain) domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag
from
(select geoid,domain,bidfloor,sz,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0108_bid)reqt left outer join
(select domain from
(select domain,count(*) ns from user_wangwentao_adx_analysis_0108_req group by domain)domainnst where ns>1000)domainnstopt on domainnstopt.domain=reqt.domain join
(select province,geoid from user_wangwentao_adx_geo_map)geomapt on reqt.geoid=geomapt.geoid
"
hive -e " 
insert overwrite table user_wangwentao_adx_traffic partition(  dd='2014-01-08'  )     
select
reqt.province,reqt.domain,reqt.sz,reqt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct('b0',b0,
'b1',b1,
'b2',b2,
'b3',b3,
'b4',b4,
'b5',b5)
from
(select
province,domain,sz,count(*) reqns,
sum(if(bidfloor<=50000,1,0)) b0,
sum(if(bidfloor>50000 and bidfloor <=100000,1,0)) b1,
sum(if(bidfloor>100000 and bidfloor<=500000,1,0)) b2,


sum(if(bidfloor>500000 and bidfloor<=1000000,1,0)) b3,
sum(if(bidfloor>1000000 and bidfloor<=2000000,1,0)) b4,
sum(if(bidfloor>2000000,1,0)) b5
from user_wangwentao_adx_analysis_0108_req_trans  
group by province,domain,sz)reqt  left outer join 
(select
province,domain,sz,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from  user_wangwentao_adx_analysis_0108_bid_trans  
group by province,domain,sz)bidt on reqt.province=bidt.province and reqt.domain=bidt.domain and reqt.sz=bidt.sz

"
hive -e "
add file nativecode2category_bid.py;
add file nativecode2category_req.py;
insert overwrite table user_wangwentao_adx_detectvertical partition( dd='2014-01-08' )     
select
req_extt.province,req_extt.domain,req_extt.self,req_extt.parent,req_extt.nativecode,req_extt.reqns,
bidns,impns,clkns,wp,bidfloor,bidprice,
named_struct(
'c0',c0,
'c1',c1,
'c2',c2,
'c3',c3,
'c4',c4)
from
(select
province,domain,self,parent,reqt.nativecode nativecode,count(*) reqns, 
sum(if(c0>0,1,0)) c0,
sum(if(c1>0,1,0)) c1,
sum(if(c2>0,1,0)) c2,
sum(if(c3>0,1,0)) c3,
sum(if(c4>0,1,0)) c4
from
(select transform(*) using 'nativecode2category_req.py' as (province,domain,bidfloor,nativecode,c0,c1,c2,c3,c4)
from  (select province,domain,bidfloor,sz,cateid,cateweg from user_wangwentao_adx_analysis_0108_req_trans )reqtmp)reqt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt1 on reqt.nativecode=categoryt1.nativecode
group by province,domain,self,parent,reqt.nativecode)req_extt left outer join
(select
province,domain,self,parent,bidt.nativecode nativecode,count(*) bidns,sum(imptag) impns,sum(clktag) clkns,sum(winprice) wp,sum(bidfloor) bidfloor,sum(bidprice) bidprice
from
(select transform(*) using 'nativecode2category_bid.py' as (province,domain,bidfloor,nativecode,bidprice,imptag,winprice,clktag)
from  (select province,domain,sz,bidfloor,cateid,cateweg,bidprice,imptag,winprice,clktag from user_wangwentao_adx_analysis_0108_bid_trans )bidtmp)bidt join  
(select nativecode,self,parent from user_wangwentao_adx_category_map)categoryt2 on bidt.nativecode=categoryt2.nativecode
group by province,domain,self,parent,bidt.nativecode)bid_extt on req_extt.province=bid_extt.province and req_extt.domain=bid_extt.domain
and req_extt.nativecode=bid_extt.nativecode 
"
hive -e "
drop table user_wangwentao_adx_analysis_0108_req;
drop table user_wangwentao_adx_analysis_0108_req_trans;
drop table user_wangwentao_adx_analysis_0108_bid;
drop table user_wangwentao_adx_analysis_0108_bid_trans;
"
